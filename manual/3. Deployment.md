# Deploy

## 须知

1. 部署机如具备 docker >= 1.12 环境， 请跳过docker的安装

1. 如需使用ansible安装方式，部署主控机必须具备:
    - python 2.7
    - ansible>2.4


--------

## 环境变量


   * PRIVATE\_REGISTRY:

     私有仓库的地址， 目前是 PRIVATE\_REGISTRY=10.142.55.199:5006

   * BASIN\_SPIDER\_CONFIG\_PATH

     爬虫的配置文件物理地址，位置为  
       ${部署安装包路径}/config/spider/basin-spider/config\_gpu'

     PS: 目前配置文件需要指定物理地址，未来配置文件需要改成使用环境变量的方式

   * SPIDER_API_URL

     爬虫api地址 目前是SPIDER_API_URL=10.142.55.199:5001

   * spider 配置文件内的ip 地址需要根据实际环境更换

      find ${BASIN_SPIDER_CONFIG_PATH} -name "*.json"|xargs sed -i "s/10.142.55.199/${TARGET_IP}/g"
      find ${BASIN_SPIDER_CONFIG_PATH} -name "*.toml"|xargs sed -i "s/10.142.55.199/${TARGET_IP}/g"

      TARGET_IP 需要设置成爬虫 几个服务运行所在的ip，因为目前都在一台机器上，所以都设置成一个




**手动设置的例子（以linux为例）**

bash 的环境变量设置方式为(具体要根据使用的shell)

```
echo "export PRIVATE_REGISTRY=10.142.55.199:5006" >> ~/.bashrc
```

每次更新环境变量必须 \(无法通过脚本完成，必须在终端执行source\) 

```
source ~/.bashrc
```

> 注意：环境变量的配置文件(~/.bashrc), 根据用户和终端的不同会有变化，部署人员需要事先了解服务器环境


## 安装步骤


## Ansible 安装步骤

1. 准备工作

- 将发布包拷贝到部署控制机上
- 部署控制机必须事先与所有部署目标机建立互信

1. 修改host配置文件

    修改 `bidspy/playbook/hosts` ，指定 docker私有镜像安装机的 IP 或者host

1. 修改全局变量

修改 `playbook/group_vars/all` 

- bidspy_dist_dir: 为发布包解压后的文件夹路径
- iface: 部署机的网卡名，用于生成/etc/hosts文件（目前假设所有部署机的网卡名一致，各部署机能互联的那个网口）
- PRIVATE_REGISTRY: 私有仓库地址
- SPIDER_API_HOST: basin_spider 部署机的地址
- SPIDER_API_PORT: basin_spider api端口


1. 安装系统

```
ansible-playbook site.yml -i hosts
```

1. 测试

```
ansible-playbook tests/test.yml -i hosts
```