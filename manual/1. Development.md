# Development


## Entries

内网:

- gitlab: http://10.142.55.199:50080
- assets(外部依赖): http://10.142.55.199:9997
- private_registry: http://10.142.55.199:5006
- jekins: http://10.142.55.199:8081

外网:

- gitbook: http://115.28.208.122:16689/
- trello: https://trello.com/b/lY0uCQ2q/basinspace

--------

## Prepare

1. 申请gitlab 账号， 地址: http://10.142.55.199:50080/
2. 联系陈牵，将账号加入群组 BasinSpace
3. 配置sshkey 到gitlab中 http://10.142.55.199:50080/profile/keys
4. 至此完成加入项目的操作
1. 研发或部署环境需要关闭selinux,否则会出现无权限等问题.

--------

## Requirement

开发机必须具备:

1. docker >= 1.12 环境
1. vagrant 
1. python >= 2.7 < 3
1. bash >= 4.0
1. git

--------

## Private Docker Registry

### 环境变量

私有仓库默认由环境变量控制

```
export PRIVATE_REGISTRY=10.142.55.199:5006
```

bash 的环境变量设置方式为(具体要根据使用的shell)

```
echo "export PRIVATE_REGISTRY=10.142.55.199:5006" >> ~/.bashrc
```

每次更新环境变量必须 \(无法通过脚本完成，必须在终端执行source\)

```
source ~/.bashrc
```

### Docker服务配置

For linux:

```
mkdir -p /etc/docker
echo '{"registry-mirrors": ["http://'${PRIVATE_REGISTRY}'"], "insecure-registries" : [ "'${PRIVATE_REGISTRY}'"] }' > /etc/docker/daemon.json
```

For Mac:

在 docker 的insecure-registries设置部分加上 ${PRIVATE_REGISTRY}

### 其他

详见 [私有仓库/镜像部署](si-you-cang-ku-bu-shu.md)

-----------

## Setup

拉取最新源码

```
git clone ssh://git@10.142.55.199:10022/basinspace/bidspy.git
```

进入项目

```
cd bidspy
```

配置开发环境（环境变量等）

```
sh setup_dev.sh
```

--------

## Project Structure

* config : 部署时， 各个模块使用的配置文件
* data : 部署后，需要导入的数据 \(有些依赖需要从外部地址拉取\)
* dist ： build 输出目录
* extractor : 招标公告抽取服务
* pipeline ：数据存储处理服务
* publisher : 订阅服务
* registry : docker 仓库
* spider : 爬虫服务 \(包含 basin-spider 和 udb-spider\)
* script : 部署相关的脚本
* build.sh : 构建入口
* setup\_dev.sh : 开发环境搭建
* test.sh : 测试入口

项目默认端口

* udb-spider 5000
* basin-spider 5001
* pipeline 7000
* repository 6000
* extractor : 12000


[各项目的docker 启动命令](qi-dong-shuo-ming.md)


--------

## 开发注意事项

##### gitlab 规范

branch：

* dev:
* master: 

##### 镜像列表

* python:2
* jfloff/alpine-python:2.7
* python:2.7-alpine
* redis:3.2.11
* mongo:3.0.15
* centos:7.4.1708
* basin/py27-spider:2.7
* basin/py27-ws:latest
* basin/py27-ml:latest


需要使用其他基础镜像需要通报， 最终更新到基础镜像列表文件：bidspy/config/base_images.txt   

