# Packaging
----------------


## 打包

```
sh build.sh
```

执行后会自动将各个服务 build 成docker image。 然后将 image ， 配置文件和安装脚本 拷贝到 `bidspy/dist` 目录下。

---

## 单机部署测试


#### 测试环境搭建

vagrant 虚拟机测试\(单机\)

```
cd bidspy
vagrant up
```

会自动启动一台 vagrant vm, 将 "./dist" 下的文件拷贝至 "/vagrant_data" 。


#### 安装验证系统

1. 进入虚拟机

    ```
    sudo vagrant ssh (密码:vagrant)
    ```

2. 执行安装部署脚本

    ```
    cd /vagrant_data
    ```

    部署私有仓库

    ```
    sh scripts/install_docker.sh
    sh scripts/start_docker.sh
    sh scripts/install_registry.sh
    sh scripts/init_registry.sh
    ```

    > 注1: 需要指定vagrant ip, 目前已经内置了一个。
    > 注2：由于vagrant 的防火墙问题， 在脚本里加入了 `iptables -F` ，实体机安装需要考虑个更好的方法。


    部署其他机器（从私有仓库拉取镜像）

    ```
    sh scripts/install_docker.sh
    sh scripts/start_docker.sh
    sh scripts/pull_docker_images.sh
    ```


3. 启动服务

    ```
    sh scripts/start_allproject.sh
    ```

    需要指定docker 仓库 ip, 目前已经内置了一个

    mongodb map路径： /data/db_tmp/datadir
    redis map路径： /data/db_tmp/redis

    其他详情查看 docker-compose.yml

    注意：如果没有分配足够的存储，mongodb 可能无法启动


4. 测试

    ```
    sh test.sh
    ```

    查看爬虫运行:
    http://10.142.55.199:50001

    查看结果（以部署在gpu1080为例）:
    http://10.142.55.199:50007/?task=test_result

-------------

# 多机部署测试

使用 ansible 实现多机部署

#### 测试环境搭建

```
cd bidspy/playbook
vagrant up
```

会启动 名为 host01 与 host02 两个vm

为使ansible 正常运行，必须事先建立互信

```
ssh-copy-id root@host01
ssh-copy-id root@host02
```

#### 安装系统

```
ansible-playbook site.yml -i hosts
```

#### 测试

```
ansible-playbook tests/test.yml -i hosts
```



---
