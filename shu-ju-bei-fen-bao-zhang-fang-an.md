# 数据备份方案
## 现状
当前bidspy数据保存在basin平台，当前主要有以下数据需要进行备份：

1. mysql 用于保存用户以及相关配置信息。
2. mongodb 用户保存采集站点配置，站点爬虫模板和采集历史数据。
3. elasticsearch 用于对爬虫采集后的内容做抽取，并保存到es数据库中，提供索引功能。


针对之前历史数据丢失，以及对系统的稳定性，对3种数据库的存储保存和恢复,提出必要数据服务保障方案。

数据实例现状，在basin平台中，elasticsearch是多实例，在一定程度上能够保证数据稳定性， mysql和mongodb还是单实例。

## 数据保障方案
### 1. mysql 

#### 1.1 全量备份
考虑mysql中数据存储暂时较小，使用全量备份方案，每日定时导出bidspy数据库。
针对后期如果数据量较大，不适用全量备份，需要增加增量备份机制，增量备份需要一定准备工作，暂时不考虑， 见参考资料。
#### 1.2 恢复方案
全量备份的数据，使用mysql自带命令能够导入到数据库中。
恢复预计时间: 当前数据库全量导出小于1M, 恢复之间能在10分钟以内。
#### 1.3 存在问题
由于间隔是每日备份，假设服务器宕机等一些异常情况，导致数据丢失，丢失1天数据量为1天。

### 2. mongo

### 2.1 全量备份
#### 2.1.1 逻辑备份
使用mongodb自带mongodump命令，导出全量数据库。
#### 2.1.2 物理备份
拷贝mongdo指定的data目录进行压缩备份。
   
#### 2.1.3 恢复方案
由于采集量较大，单独针对爬虫的模板配置采用全量备份和全量恢复,
对于采集的结果，采用增量备份方案。

### 2.2 增量备份
mongodb支持开启oplog，对数据库的操作均会有记录，但该方案需要集群模式下才有oplog，单机无效，采用每日定时查询数据库新增操作，并插入到备份数据库中。

#### 2.2.1 恢复方案
拷贝备份库覆盖生产库。
恢复时长: 现有数据库大约500M，考虑复制备份数据库到生产环境在执行恢复，大约需要30分钟-1小时。

#### 2.2.3 存在问题
由于增量备份，只做新增部分备份，对于生产环境有删除记录的操作，不会同步到备份数据库中， 此场景对现有业务不影响。


### 3. elasticsearch
basin对elasticsearch有多实例机制，elasticsearch暂时还没实际验证过。所以暂时没有明确方案，待考虑。


### 参考:
1. [MySQL增量备份与恢复实例](http://seanlook.com/2014/12/05/mysql_incremental_backup_example/)
2. [Mongodb秒级备份恢复](http://oqt2eqc1u.bkt.clouddn.com/MongoDB%E7%A7%92%E7%BA%A7%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D.pdf)

